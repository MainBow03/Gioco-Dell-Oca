import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken,
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  updateDoc,
  arrayUnion
} from 'firebase/firestore';
import { 
  Dice5, LogOut, ArrowRight, Skull, RefreshCcw, 
  ArrowUp, ArrowDown, Footprints, Crown, Trophy, 
  Zap, Bomb, Flag, Flame, Ghost, ShieldAlert, Pointer, Dices, Info, Medal, User, X, ChevronsUp
} from 'lucide-react';

// --- FIREBASE SETUP ---
// Configurazione del tuo progetto "minigioconi-pincher"
const firebaseConfig = {
  apiKey: "AIzaSyByjL38jkKzJfmgmqGisDO8C80xP-8q_Fo",
  authDomain: "minigioconi-pincher.firebaseapp.com",
  projectId: "minigioconi-pincher",
  storageBucket: "minigioconi-pincher.firebasestorage.app",
  messagingSenderId: "878254008054",
  appId: "1:878254008054:web:6b20103369dc688f736ed7",
  measurementId: "G-VC4H1N492S"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Usiamo un ID fisso per il tuo progetto personale per garantire che i dati vadano sempre nello stesso posto
const appId = 'multiverse_goose_game';

// --- ROSTER DATI (CON DADI SPECIALI) ---
const ROSTER = [
  { 
    name: "Marinette", 
    img: "https://i.pinimg.com/736x/b8/74/55/b87455575cd069609007a639c9490293.jpg",
    dice: { name: "Dado Fortunato", vals: [0, 2, 4, 4, 4, 5], color: "bg-pink-500", text: "text-pink-500", desc: "Niente rischi, solo progressi costanti." }
  },
  { 
    name: "Adrien", 
    img: "https://i.pinimg.com/1200x/5c/2d/c7/5c2dc740ed2fe906b6afaf1320bf4273.jpg",
    dice: { name: "Dado Cataclisma", vals: [-2, -1, 0, 3, 6, 9], color: "bg-gray-800", text: "text-gray-800", desc: "Estremi pericolosi: o voli o crolli." }
  },
  { 
    name: "Re Julien", 
    img: "https://i.pinimg.com/736x/1e/17/19/1e17194ef5b383e4202fbb4875cfbd81.jpg",
    dice: { name: "Dado da Re", vals: [2, 2, 2, 2, 2, 3], color: "bg-yellow-500", text: "text-yellow-500", desc: "Un re non corre, incede con grazia." }
  },
  { 
    name: "Gwen", 
    img: "https://i.pinimg.com/1200x/59/d7/15/59d71578cd5f889ae898bbc83dda29dc.jpg",
    dice: { name: "Dado Solitario", vals: [3, 3, 3, 3, 3, 3], color: "bg-teal-600", text: "text-teal-600", desc: "La coerenza è la chiave della vittoria." }
  },
  { 
    name: "Heather", 
    img: "https://i.pinimg.com/736x/81/5b/b6/815bb632721e7d38f26d35801466dd30.jpg",
    dice: { name: "Dado Villain", vals: [-1, 1, 2, 2, 6, 8], color: "bg-purple-800", text: "text-purple-800", desc: "Pianifica, indietreggia, colpisci duro." }
  },
  { 
    name: "Lindsay", 
    img: "https://i.pinimg.com/1200x/ed/96/df/ed96df179eaa7030663473c575067cb4.jpg",
    dice: { name: "Dado Stupido", vals: [-6, 0, 0, 0, 0, 10], color: "bg-orange-300", text: "text-orange-500", desc: "O disastro totale o miracolo assoluto." }
  },
  { 
    name: "Yoshi", 
    img: "https://i.pinimg.com/736x/f3/05/7f/f3057f14de68b0afe682ffe93dcc479b.jpg",
    dice: { name: "Dado Uovo", vals: [2, 2, 2, 3, 3, 3], color: "bg-green-500", text: "text-green-500", desc: "Piccoli saltelli felici verso la meta." }
  },
  { 
    name: "Wario", 
    img: "https://i.pinimg.com/736x/2f/ea/be/2feabe47151fd436fbf358c299eb4870.jpg",
    dice: { name: "Dado WAH?", vals: [0, 0, 0, 2, 6, 6], color: "bg-yellow-600", text: "text-yellow-700", desc: "Pigrizia o avidità, niente vie di mezzo." }
  },
  { 
    name: "Tanjiro", 
    img: "https://i.pinimg.com/736x/e9/6d/20/e96d20e7c159897a05c6baa57fac7f35.jpg",
    dice: { name: "Dado d'Acqua", vals: [0, 1, 2, 5, 6, 7], color: "bg-cyan-500", text: "text-cyan-600", desc: "Fluido come l'acqua, a volte calmo a volte impetuoso." }
  },
  { 
    name: "Mr Krab", 
    img: "https://i.pinimg.com/1200x/74/9c/f5/749cf53dd48dbb440fcde8d958c7dbb1.jpg",
    dice: { name: "Dado Greedy", vals: [-2, -2, -2, 8, 8, 8], color: "bg-red-600", text: "text-red-600", desc: "Rischia tutto per il malloppo grosso." }
  },
  { 
    name: "Gumball", 
    img: "https://i.pinimg.com/736x/ae/88/e3/ae88e329120b3edc196af1ebbfd8fe07.jpg",
    dice: { name: "Dado Caotico", vals: [0, 0, 3, 3, 3, 6], color: "bg-blue-400", text: "text-blue-500", desc: "Un disastro controllato." }
  },
  { 
    name: "Johnny Bravo", 
    img: "https://i.pinimg.com/736x/4a/62/70/4a6270678f7adcf130672bcd0af41fdf.jpg",
    dice: { name: "Dado Oh Yeah", vals: [0, 0, 1, 6, 7, 8], color: "bg-black", text: "text-black", desc: "Fatti bello e spera nel meglio." }
  },
  { 
    name: "Steven", 
    img: "https://i.pinimg.com/736x/2b/fd/20/2bfd202ab782611ea6a0fb0cdcdc37ab.jpg",
    dice: { name: "Dado Diamantato", vals: [1, 1, 1, 1, 2, 3], color: "bg-pink-300", text: "text-pink-400", desc: "Lento e protettivo, ma sicuro." }
  },
  { 
    name: "Ariana Grande", 
    img: "https://media.tenor.com/1u94p6qR01gAAAAM/ariana-grande-eternal-sunshine.gif",
    dice: { name: "Dado YUH", vals: [0, 0, 1, 5, 6, 8], color: "bg-indigo-300", text: "text-indigo-400", desc: "Note alte e passi lunghi (se canti)." }
  },
  { 
    name: "Will", 
    img: "https://i.pinimg.com/originals/88/80/73/8880736b5695844044e0e38c8063a1ff.gif",
    dice: { name: "Dado Rainbow", vals: [3, 3, 3, 3, 3, 6], color: "bg-indigo-500", text: "text-indigo-500", desc: "Costante con un tocco di favolosità." }
  },
  { 
    name: "Carlos Oliveira", 
    img: "https://i.pinimg.com/originals/32/0d/d1/320dd13031f1aba8a2d3d9b9837174f4.gif",
    dice: { name: "Dado Peloso", vals: [-2, 0, 2, 4, 6, 8], color: "bg-orange-800", text: "text-orange-800", desc: "Selvaggio e imprevedibile." }
  },
  { 
    name: "Leon", 
    img: "https://i.pinimg.com/736x/db/ef/fc/dbeffc6e915a929f7dbe908390f5af42.jpg",
    dice: { name: "Dado Carismatico", vals: [2, 2, 2, 5, 5, 5], color: "bg-blue-800", text: "text-blue-800", desc: "Solo numeri stilosi." }
  },
  { 
    name: "Finn", 
    img: "https://i.pinimg.com/736x/7e/0b/c9/7e0bc9826a7652264f32a44bc8a40ede.jpg",
    dice: { name: "Dado Cauto", vals: [1, 1, 1, 1, 1, 1], color: "bg-blue-300", text: "text-blue-400", desc: "Un passo alla volta, eroe." }
  },
  { 
    name: "Jake", 
    img: "https://i.pinimg.com/1200x/cd/77/22/cd7722b2f98ffc75d1128913df6861d7.jpg",
    dice: { name: "Dado Rischioso", vals: [-3, -3, -3, 7, 8, 8], color: "bg-yellow-400", text: "text-yellow-600", desc: "Allungati troppo e torni indietro." }
  },
  { 
    name: "Stewie", 
    img: "https://i.pinimg.com/1200x/1e/a2/cc/1ea2cc7a197e3841086f4a1ce18b089c.jpg",
    dice: { name: "Genio del Male", vals: [1, 3, 5, 6, 7, 7], color: "bg-red-500", text: "text-red-500", desc: "Piani complessi per grandi risultati." }
  },
  { 
    name: "Peter", 
    img: "https://i.pinimg.com/736x/9e/40/74/9e4074bbe7890cd245b51b9ff5c0e33c.jpg",
    dice: { name: "Dado Affamato", vals: [1, 2, 2, 2, 7, 8], color: "bg-green-600", text: "text-green-700", desc: "Corri verso il buffet." }
  },
  { 
    name: "Ashley", 
    img: "https://i.pinimg.com/736x/d1/c5/5f/d1c55f57218baecf0c2e160155e80c61.jpg",
    dice: { name: "Dado Ti Amo", vals: [3, 3, 3, 3, 3, 3], color: "bg-red-400", text: "text-red-400", desc: "Amore costante e ripetitivo." }
  },
  { 
    name: "Nicole", 
    img: "https://i.pinimg.com/736x/81/24/e4/8124e43da43e1d06dcdbca15f22a0cd9.jpg",
    dice: { name: "Dado Materno", vals: [0, 0, 2, 5, 5, 5], color: "bg-blue-500", text: "text-blue-600", desc: "Severa ma giusta." }
  },
  {
    name: "Lapis",
    img: "https://i.pinimg.com/1200x/09/fb/12/09fb12467957da96913fc8f75e6f6356.jpg",
    dice: { name: "Dado Tsunami", vals: [-4, -2, 0, 6, 8, 10], color: "bg-blue-600", text: "text-blue-600", desc: "La forza dell'oceano: devastante o ritirata." }
  }
].map((c, i) => ({ ...c, id: i }));

// --- SOUND ENGINE ---
const playSound = (type) => {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    const now = ctx.currentTime;
    
    if (type === 'click') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(600, now);
      gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'step') {
      osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now);
      gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      osc.start(now); osc.stop(now + 0.1);
    } else if (type === 'eliminated') {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
      osc.frequency.linearRampToValueAtTime(50, now + 1);
      gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now + 1);
      osc.start(now); osc.stop(now + 1);
    } else if (type === 'win') {
      osc.type = 'square'; 
      osc.frequency.setValueAtTime(440, now);
      osc.frequency.setValueAtTime(554, now + 0.2);
      osc.frequency.setValueAtTime(659, now + 0.4);
      gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.8);
      osc.start(now); osc.stop(now + 0.8);
    }
  } catch (e) { console.error(e); }
};

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// --- MAPPE DI GIOCO ---

// NOTE: name = testo corto per la casella, desc = descrizione lunga per il modal

// MAPPA CLASSICA (60 Caselle)
const CLASSIC_MAP = {
  max: 60,
  specials: {
    6: { type: 'JUMP', val: 12, name: 'Ponte', icon: <ArrowRight />, desc: "Attraversa il ponte! Vai direttamente alla casella 12." },
    19: { type: 'WAIT', turns: 2, name: 'Pozzo', icon: <RefreshCcw />, desc: "Sei caduto nel Pozzo! Devi aspettare 2 turni per risalire." }, // Modificato a 2 turni
    31: { type: 'WAIT', turns: 2, name: 'Pozzo 2', icon: <RefreshCcw />, desc: "Un altro pozzo! Aspetta 2 turni." },
    42: { type: 'BACK', val: 30, name: 'Labirinto', icon: <ArrowDown />, desc: "Ti sei perso nel Labirinto! Torni indietro alla casella 30." }, // Modificato target a 30
    52: { type: 'WAIT', turns: 2, name: 'Prigione', icon: <ShieldAlert />, desc: "Sei stato arrestato! Rimani in Prigione per 2 turni." }, // Modificato a 2 turni
    58: { type: 'RESTART', name: 'Scheletro', icon: <Skull />, desc: "Lo Scheletro ti ha spaventato! Torni all'inizio (START)." },
    
    // Nuove Caselle Richieste
    5: { type: 'BOOST', val: 2, name: '+2', icon: <ArrowUp />, desc: "Un piccolo aiuto: avanza di 2 caselle." },
    9: { type: 'BOOST', val: 3, name: '+3', icon: <Zap />, desc: "Sprint! Corri avanti di 3 caselle." },
    14: { type: 'BOOST', val: 2, name: '+2', icon: <ArrowUp />, desc: "Un piccolo aiuto: avanza di 2 caselle." },
    23: { type: 'BOOST', val: -2, name: '-2', icon: <ArrowDown />, desc: "Scivolata nel fango! Torni indietro di 2 caselle." },
    27: { type: 'BOOST', val: -1, name: '-1', icon: <ArrowDown />, desc: "Vento contrario! Torni indietro di 1 casella." },
    36: { type: 'BOOST', val: 3, name: '+3', icon: <Zap />, desc: "Sprint! Corri avanti di 3 caselle." },
    38: { type: 'DOUBLE', name: 'Raddoppia', icon: <ChevronsUp />, desc: "Super Bonus! Avanzi ancora del risultato che hai appena fatto x2!" }, // NUOVA CASELLA RADDOPPIA
    45: { type: 'TAIL', name: 'In Coda', icon: <Footprints />, desc: "Ti metti in scia! Ti teletrasporti subito dietro al giocatore che ti precede in classifica." },
    50: { type: 'BOOST', val: -2, name: '-2', icon: <ArrowDown />, desc: "Scivolata nel fango! Torni indietro di 2 caselle." },
    54: { type: 'BOOST', val: 2, name: '+2', icon: <ArrowUp />, desc: "Un piccolo aiuto: avanza di 2 caselle." },
  }
};

// MAPPA ELIMINAZIONE (34 Caselle - Piu veloce e cattiva)
const ELIM_MAP = {
  max: 34,
  specials: {
    3: { type: 'BOOST', val: 3, name: '+3', icon: <Zap />, desc: "Sprint iniziale! +3 caselle." },
    7: { type: 'BOOST', val: 3, name: '+3', icon: <Zap />, desc: "Sprint! +3 caselle." },
    8: { type: 'DOUBLE', name: 'Raddoppia', icon: <ChevronsUp />, desc: "Super Bonus! Avanzi ancora del risultato che hai appena fatto x2!" }, // NUOVA CASELLA RADDOPPIA
    12: { type: 'BACK', val: 5, name: 'Trappola', icon: <Bomb />, desc: "È una trappola! Torni alla casella 5." },
    15: { type: 'BOOST', val: 4, name: '+4', icon: <Zap />, desc: "Mega Sprint! Corri avanti di 4 caselle." },
    20: { type: 'BACK', val: 10, name: 'Labirinto', icon: <ArrowDown />, desc: "Labirinto insidioso! Torni alla casella 10." }, // Modificato a BACK 10
    25: { type: 'BACK', val: 18, name: 'Tornado', icon: <ArrowDown />, desc: "Un tornado ti spazza via! Torni alla 18." },
    28: { type: 'TAIL', name: 'In Coda', icon: <Footprints />, desc: "Ti metti in scia! Ti teletrasporti dietro al giocatore davanti a te." },
    32: { type: 'BOOST', val: -2, name: '-2', icon: <ArrowDown />, desc: "Sei quasi alla fine ma scivoli! Indietro di 2." },
  }
};

// --- COMPONENTI UI ---

const PlayerAvatar = ({ charId, size = "md", border = true }) => {
  const s = size === 'sm' ? 'w-8 h-8' : size === 'lg' ? 'w-16 h-16' : 'w-10 h-10';
  if (charId < 0 || charId >= ROSTER.length) return null;
  return (
    <img 
      src={ROSTER[charId].img} 
      className={`${s} rounded-full object-cover ${border ? 'border-2 border-white shadow-sm' : ''}`} 
      alt="Avatar"
    />
  );
};

const BoardCell = ({ num, players, special, isElimination, isPendingTarget, onCellClick, onInfoClick }) => {
  let bgClass = "bg-slate-100";
  let borderClass = "border-slate-300";
  let cursorClass = "cursor-pointer"; // Ora tutte cliccabili per info
  let highlightClass = "";
  
  if (num === 0) { bgClass = "bg-green-200"; borderClass = "border-green-400"; }
  else if (num === (isElimination ? 34 : 60)) { bgClass = "bg-yellow-200"; borderClass = "border-yellow-400"; }
  else if (special) {
    if (special.type === 'BOOST' && special.val > 0 || special.type === 'JUMP' || special.type === 'DOUBLE') { bgClass = "bg-cyan-100"; borderClass = "border-cyan-300"; }
    else if ((special.type === 'BOOST' && special.val < 0) || special.type === 'BACK' || special.type === 'RESTART') { bgClass = "bg-red-100"; borderClass = "border-red-300"; }
    else if (special.type === 'WAIT') { bgClass = "bg-slate-300"; borderClass = "border-slate-500"; }
    else if (special.type === 'TAIL') { bgClass = "bg-purple-200"; borderClass = "border-purple-400"; }
  }

  if (isPendingTarget) {
     highlightClass = "ring-4 ring-yellow-400 ring-offset-2 animate-pulse z-20 shadow-xl bg-yellow-50 scale-105";
     cursorClass = "cursor-pointer hover:bg-yellow-100";
  }

  return (
    <div 
      onClick={() => {
        if (isPendingTarget) onCellClick();
        else if (special) onInfoClick(special);
      }}
      className={`relative w-full aspect-square border-2 rounded-xl flex flex-col p-1 shadow-sm transition-all duration-300 ${bgClass} ${borderClass} ${highlightClass} ${cursorClass}`}
    >
      <div className="flex justify-between items-start opacity-60">
        <span className="font-bold text-xs md:text-sm">{num === 0 ? 'START' : num}</span>
        {special && <span className="text-xs">{special.icon}</span>}
      </div>
      
      {/* Player Tokens */}
      <div className="flex-1 flex flex-wrap content-center justify-center gap-1 z-10">
        {players.map(p => (
           <div key={p.uid} className={`relative transition-all duration-300 ${p.finished ? 'opacity-50 scale-75' : 'hover:scale-125 hover:z-20'}`}>
              <PlayerAvatar charId={p.characterId} size="sm" />
              {p.skipTurns > 0 && <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center text-white text-[10px] font-bold">{p.skipTurns}</div>}
              {p.finished && <div className="absolute -top-1 -right-1 bg-green-500 text-white rounded-full p-0.5"><Flag size={8}/></div>}
           </div>
        ))}
      </div>
      
      {isPendingTarget && (
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
          <Pointer className="text-yellow-600 animate-bounce w-8 h-8 drop-shadow-md fill-yellow-300" />
        </div>
      )}

      {special && <div className="text-[8px] md:text-[10px] text-center leading-tight truncate font-semibold opacity-80">{special.name}</div>}
    </div>
  );
};

// --- LOGICA PRINCIPALE ---

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('menu');
  const [roomCode, setRoomCode] = useState('');
  const [nickname, setNickname] = useState('');
  const [currentRoom, setCurrentRoom] = useState(null);
  const [isRolling, setIsRolling] = useState(false);
  const [isMoving, setIsMoving] = useState(false); 
  const [lastRoll, setLastRoll] = useState(null);
  const [notif, setNotif] = useState(null); 
  const [selectedCellInfo, setSelectedCellInfo] = useState(null);
  
  const [useSpecialDie, setUseSpecialDie] = useState(false);

  // Auth
  useEffect(() => {
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        console.error("Auth error", e);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, u => setUser(u));
  }, []);

  // Room Listener
  useEffect(() => {
    if (!roomCode) return;
    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        setCurrentRoom(data);
        if (data.status === 'playing' && view !== 'game') setView('game');
        if (data.status === 'waiting' && view !== 'lobby') setView('lobby');
      } else {
        setView('menu');
      }
    });
    return () => unsub();
  }, [roomCode, view]);

  // Notifications
  useEffect(() => {
    if (currentRoom?.lastAction) {
       setNotif(currentRoom.lastAction);
       const t = setTimeout(() => setNotif(null), 3000);
       return () => clearTimeout(t);
    }
  }, [currentRoom?.lastAction]);

  // Actions
  const createRoom = async (mode) => {
    if (!nickname || !user) return;
    const code = Math.random().toString(36).substring(2, 7).toUpperCase();
    const charId = Math.floor(Math.random() * ROSTER.length);
    
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', code), {
      code,
      hostId: user.uid,
      gameMode: mode, 
      status: 'waiting',
      currentTurn: 0,
      round: 1, 
      players: [{
        uid: user.uid,
        name: nickname,
        characterId: charId,
        position: 0,
        skipTurns: 0,
        finished: false,
        isDead: false,
        rank: 0,
        isBot: false,
        pendingTarget: null 
      }],
      lastAction: "Stanza Creata"
    });
    setRoomCode(code);
    setView('lobby');
  };

  const joinRoom = async () => {
    if (!nickname || !user || !roomCode) return;
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode.toUpperCase());
    const snap = await getDoc(ref);
    if (!snap.exists()) return;
    
    const data = snap.data();
    if (data.status !== 'waiting') return;
    if (data.players.some(p => p.uid === user.uid)) { setView('lobby'); return; }

    const available = ROSTER.map(c=>c.id).filter(id => !data.players.some(p=>p.characterId === id));
    const charId = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : 0;

    await updateDoc(ref, {
      players: arrayUnion({
        uid: user.uid,
        name: nickname,
        characterId: charId,
        position: 0,
        skipTurns: 0,
        finished: false,
        isDead: false,
        rank: 0,
        isBot: false,
        pendingTarget: null
      })
    });
    setView('lobby');
  };

  const addBot = async () => {
    if (!currentRoom) return;
    const available = ROSTER.map(c=>c.id).filter(id => !currentRoom.players.some(p=>p.characterId === id));
    const charId = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : 0;
    const botId = `bot_${Date.now()}`;
    
    const newBot = {
      uid: botId,
      name: `BOT ${ROSTER[charId].name.split(' ')[0]}`,
      characterId: charId,
      position: 0,
      skipTurns: 0,
      finished: false,
      isDead: false,
      rank: 0,
      isBot: true,
      pendingTarget: null
    };
    
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), {
      players: [...currentRoom.players, newBot]
    });
  };

  const selectChar = async (charId) => {
    if (!currentRoom) return;
    if (currentRoom.players.some(p => p.characterId === charId)) return;
    const updated = currentRoom.players.map(p => p.uid === user.uid ? { ...p, characterId: charId } : p);
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { players: updated });
  };

  const startGame = async () => {
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { status: 'playing', lastAction: "La gara inizia!" });
  };

  // --- GAME LOGIC ---
  
  const executeMove = async (playerId, targetPos) => {
     if (isMoving) return;
     setIsMoving(true);
     playSound('click');

     const pIndex = currentRoom.players.findIndex(p => p.uid === playerId);
     if (pIndex === -1) { setIsMoving(false); return; }
     
     const player = currentRoom.players[pIndex];
     const currentPos = player.position;
     const config = currentRoom.gameMode === 'elimination' ? ELIM_MAP : CLASSIC_MAP;

     // Calculate visual path 
     const steps = [];
     const direction = targetPos >= currentPos ? 1 : -1;
     const dist = Math.abs(targetPos - currentPos); // This is effectively the "roll" distance for Double check
     
     for (let i = 1; i <= dist; i++) {
        steps.push(currentPos + (i * direction));
     }
     
     // GRADUAL MOVEMENT 
     let tempPlayers = [...currentRoom.players];
     for (let stepPos of steps) {
         tempPlayers[pIndex] = { ...tempPlayers[pIndex], position: stepPos };
         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { 
             players: tempPlayers
         });
         playSound('step');
         await sleep(250); 
     }

     // FINAL LANDING LOGIC
     let finalPos = targetPos;
     let log = `${player.name} è arrivato alla ${finalPos}.`;
     let special = config.specials[finalPos];
     let extraTurns = 0;

     if (special) {
         log += ` ${special.name}!`; // Use short name
         
         if (special.type === 'BOOST') {
            await sleep(500);
            finalPos += special.val; 
            if (finalPos < 0) finalPos = 0;
            tempPlayers[pIndex] = { ...tempPlayers[pIndex], position: finalPos };
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { players: tempPlayers });
            playSound('step');
         }
         else if (special.type === 'JUMP' || special.type === 'BACK' || special.type === 'RESTART') {
            await sleep(800);
            finalPos = special.val || 0;
            tempPlayers[pIndex] = { ...tempPlayers[pIndex], position: finalPos };
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { players: tempPlayers });
            playSound('step');
         }
         else if (special.type === 'DOUBLE') { // LOGICA RADDOPPIA
             await sleep(800);
             // Il "tiro" appena fatto è la distanza percorsa per arrivare qui (dist)
             const extraMove = dist * 2;
             log += ` Avanza ancora di ${extraMove} caselle!`;
             finalPos = Math.min(config.max, finalPos + extraMove);
             
             tempPlayers[pIndex] = { ...tempPlayers[pIndex], position: finalPos };
             await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { players: tempPlayers });
             playSound('step');
         }
         else if (special.type === 'TAIL') {
             await sleep(800);
             const sortedByPos = [...tempPlayers].filter(p => !p.isDead).sort((a,b) => b.position - a.position);
             const myRankIdx = sortedByPos.findIndex(p => p.uid === playerId);
             
             if (myRankIdx > 0) {
                 const targetPlayer = sortedByPos[myRankIdx - 1]; 
                 log += ` Scatta dietro a ${targetPlayer.name}!`;
                 finalPos = Math.max(0, targetPlayer.position - 1);
             } else {
                 log += ` Ma è già in testa!`;
             }
             tempPlayers[pIndex] = { ...tempPlayers[pIndex], position: finalPos };
             await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), { players: tempPlayers });
             playSound('step');
         }
         
         if (special.type === 'WAIT') extraTurns = special.turns;
     }

     // COMMIT FINAL STATE
     tempPlayers[pIndex] = { 
         ...tempPlayers[pIndex], 
         position: finalPos, 
         skipTurns: extraTurns,
         pendingTarget: null 
     };

     // WIN / FINISH LOGIC
     let updates = { players: tempPlayers, lastAction: log };

     if (finalPos === config.max) {
      tempPlayers[pIndex].finished = true;
      const rank = tempPlayers.filter(p => p.finished).length; 
      tempPlayers[pIndex].rank = rank;
      log += " TRAGUARDO!";
      playSound('win');
    }

     // NEXT TURN LOGIC
     if (currentRoom.gameMode === 'elimination') {
       const living = tempPlayers.filter(p => !p.isDead);
       const finished = living.filter(p => p.finished);
       
       if (finished.length === living.length - 1 && living.length > 1) {
          const loser = living.find(p => !p.finished);
          const loserIndex = tempPlayers.findIndex(p => p.uid === loser.uid);
          
          tempPlayers[loserIndex].isDead = true;
          tempPlayers[loserIndex].position = 0; 
          
          tempPlayers.forEach(p => {
            if (!p.isDead) {
              p.position = 0;
              p.finished = false;
              p.rank = 0;
              p.skipTurns = 0;
              p.pendingTarget = null;
            }
          });
          
          updates.players = tempPlayers;
          updates.round = currentRoom.round + 1;
          updates.lastAction = `${loser.name} è stato ELIMINATO! Inizia il Round ${updates.round}!`;
          playSound('eliminated');
          updates.currentTurn = 0;
       } else if (living.length === 1 && living[0].finished) {
          updates.status = 'finished';
          updates.winner = living[0].uid;
          updates.lastAction = `VITTORIA TOTALE PER ${living[0].name}!`;
       } else {
          updates.currentTurn = getNextTurn(tempPlayers, currentRoom.currentTurn);
       }
     } else {
       if (finalPos === config.max) {
         updates.status = 'finished';
         updates.winner = playerId;
       } else {
         updates.currentTurn = getNextTurn(tempPlayers, currentRoom.currentTurn);
       }
     }

     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), updates);
     setIsMoving(false);
  };

  const handleRoll = async () => {
    if (isRolling || isMoving || !currentRoom) return;
    const player = currentRoom.players[currentRoom.currentTurn];
    if (player.uid !== user.uid && !player.isBot) return;
    
    // Check skipTurns
    if (player.skipTurns > 0) {
       const updated = [...currentRoom.players];
       updated[currentRoom.currentTurn].skipTurns -= 1;
       const next = getNextTurn(updated, currentRoom.currentTurn);
       await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), {
         players: updated,
         currentTurn: next,
         lastAction: `${player.name} salta il turno.`
       });
       return;
    }

    setIsRolling(true);
    playSound('step');
    
    const isSpecial = useSpecialDie && !player.isBot;
    const specialDice = ROSTER[player.characterId].dice;
    
    // Fake animation
    for(let i=0; i<10; i++) {
       const animVal = isSpecial ? specialDice.vals[Math.floor(Math.random()*6)] : Math.floor(Math.random()*6)+1;
       setLastRoll(animVal);
       await sleep(50);
    }
    
    const val = isSpecial 
       ? specialDice.vals[Math.floor(Math.random() * 6)] 
       : Math.floor(Math.random() * 6) + 1;
       
    setLastRoll(val);
    await sleep(200);

    const config = currentRoom.gameMode === 'elimination' ? ELIM_MAP : CLASSIC_MAP;
    
    let newPos = player.position + val;
    
    // Bounce back
    if (newPos > config.max) {
       const excess = newPos - config.max;
       newPos = config.max - excess;
    }
    if (newPos < 0) newPos = 0;
    
    if (val === 0) {
        newPos = player.position;
    }
    
    const updated = [...currentRoom.players];
    updated[currentRoom.currentTurn] = { ...player, pendingTarget: newPos };
    
    const dieName = isSpecial ? specialDice.name : "Dado Standard";
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', roomCode), {
         players: updated,
         lastAction: `${player.name} (${dieName}): ${val}! Clicca sulla casella ${newPos}!`
    });
    
    setIsRolling(false);
  };

  const getNextTurn = (players, currentIdx) => {
    let next = (currentIdx + 1) % players.length;
    let loop = 0;
    while(players[next].isDead || players[next].finished || players[next].skipTurns > 0) {
      if (loop > players.length * 2) return currentIdx; 
      next = (next + 1) % players.length;
      loop++;
    }
    return next;
  };

  // BOT LOGIC
  useEffect(() => {
    if (currentRoom?.status === 'playing') {
       const p = currentRoom.players[currentRoom.currentTurn];
       if (p.isBot && currentRoom.hostId === user?.uid && !isRolling && !isMoving && p.pendingTarget === null) {
         const t = setTimeout(() => handleRoll(), 1500);
         return () => clearTimeout(t);
       }
       if (p.isBot && currentRoom.hostId === user?.uid && p.pendingTarget !== null && !isMoving) {
          const t = setTimeout(() => executeMove(p.uid, p.pendingTarget), 1500);
          return () => clearTimeout(t);
       }
    }
  }, [currentRoom, isRolling, isMoving]);

  // --- RENDER ---
  
  if (!user) return <div className="h-screen flex items-center justify-center bg-slate-900 text-white">Caricamento...</div>;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans flex flex-col relative">
       
       {/* MODAL INFO CASELLA */}
       {selectedCellInfo && (
         <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
            <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl relative border-4 border-indigo-200">
               <button onClick={()=>setSelectedCellInfo(null)} className="absolute top-2 right-2 p-1 rounded-full hover:bg-slate-100">
                  <X size={20} className="text-slate-500"/>
               </button>
               <div className="flex flex-col items-center text-center gap-3">
                  <div className="p-4 bg-indigo-50 rounded-full text-indigo-600 mb-2 scale-125">
                     {selectedCellInfo.icon}
                  </div>
                  <h3 className="text-2xl font-black text-indigo-900">{selectedCellInfo.name}</h3>
                  <p className="text-lg text-slate-600 font-medium leading-relaxed">
                     {selectedCellInfo.desc}
                  </p>
                  <button onClick={()=>setSelectedCellInfo(null)} className="mt-4 w-full py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">
                     Capito!
                  </button>
               </div>
            </div>
         </div>
       )}

       {/* NAVBAR */}
       <div className="bg-indigo-900 text-white p-3 flex justify-between items-center shadow-lg z-50">
          <div className="font-black text-xl flex items-center gap-2"><ArrowRight className="text-yellow-400"/> MULTIVERSE RUN</div>
          {currentRoom && <div className="font-mono bg-indigo-800 px-2 py-1 rounded text-xs">ROOM: {currentRoom.code}</div>}
          {view !== 'menu' && <button onClick={() => { setView('menu'); setRoomCode(''); }}><LogOut size={20}/></button>}
       </div>

       {/* NOTIFICATION TOAST */}
       <div className={`fixed top-16 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-2 rounded-full shadow-2xl transition-all duration-300 z-50 font-bold border border-slate-600 ${notif ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-10 pointer-events-none'}`}>
          {notif}
       </div>

       <div className="flex-1 flex overflow-hidden">
          
          {/* MAIN CONTENT */}
          <div className="flex-1 overflow-y-auto p-4 flex flex-col items-center">
            
            {view === 'menu' && (
              <div className="max-w-md w-full mt-10 space-y-6">
                 <div className="text-center">
                    <h1 className="text-4xl font-black text-indigo-900 mb-2">SCEGLI IL TUO DESTINO</h1>
                    <p className="text-slate-500">Corsa classica o sopravvivenza?</p>
                 </div>
                 
                 <input 
                   type="text" placeholder="Il tuo Nickname" 
                   className="w-full p-4 text-center text-xl font-bold rounded-xl border-2 border-slate-300 focus:border-indigo-500 outline-none"
                   value={nickname} onChange={e=>setNickname(e.target.value)}
                 />

                 <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => createRoom('classic')} disabled={!nickname} className="h-40 bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl text-white font-black text-xl shadow-xl hover:scale-105 transition-all flex flex-col items-center justify-center gap-2">
                       <Flag size={40} className="drop-shadow-md"/>
                       CLASSICA
                       <span className="text-xs font-normal opacity-80">Primo al traguardo</span>
                    </button>
                    <button onClick={() => createRoom('elimination')} disabled={!nickname} className="h-40 bg-gradient-to-br from-red-500 to-orange-600 rounded-xl text-white font-black text-xl shadow-xl hover:scale-105 transition-all flex flex-col items-center justify-center gap-2">
                       <Skull size={40} className="drop-shadow-md"/>
                       ELIMINAZIONE
                       <span className="text-xs font-normal opacity-80">Ultimo eliminato ogni round</span>
                    </button>
                 </div>

                 <div className="flex gap-2">
                    <input id="codeIn" type="text" placeholder="CODICE" className="flex-1 p-3 rounded-xl border-2 font-mono text-center uppercase font-bold"/>
                    <button onClick={() => { setRoomCode(document.getElementById('codeIn').value); joinRoom(); }} disabled={!nickname} className="px-6 bg-slate-800 text-white font-bold rounded-xl">ENTRA</button>
                 </div>
              </div>
            )}

            {view === 'lobby' && currentRoom && (
              <div className="w-full max-w-4xl space-y-6">
                 <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                       <h2 className="text-2xl font-black text-indigo-900">LOBBY {currentRoom.gameMode === 'classic' ? 'CLASSICA' : 'ELIMINAZIONE'}</h2>
                       <p className="text-slate-500">Giocatori: {currentRoom.players.length}</p>
                    </div>
                    {currentRoom.hostId === user.uid && (
                      <div className="flex gap-2">
                         <button onClick={addBot} className="bg-slate-200 px-4 py-2 rounded-lg font-bold hover:bg-slate-300">AGGIUNGI BOT</button>
                         <button onClick={startGame} className="bg-green-500 text-white px-8 py-2 rounded-lg font-bold shadow-lg hover:bg-green-600 hover:scale-105 transition-all">START</button>
                      </div>
                    )}
                 </div>

                 <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
                    {ROSTER.map(c => {
                       const taken = currentRoom.players.some(p => p.characterId === c.id);
                       const mine = currentRoom.players.find(p => p.uid === user.uid)?.characterId === c.id;
                       return (
                         <button key={c.id} onClick={() => selectChar(c.id)} disabled={taken && !mine} className={`relative group aspect-[3/4] rounded-xl overflow-hidden transition-all bg-slate-100 flex flex-col items-center ${mine ? 'ring-4 ring-indigo-500 scale-105 z-10' : 'hover:scale-105'} ${taken && !mine ? 'grayscale opacity-50' : ''}`}>
                            <div className="flex-1 w-full overflow-hidden">
                               <img src={c.img} className="w-full h-full object-cover"/>
                            </div>
                            <div className={`w-full text-[8px] md:text-[10px] p-1 font-bold text-center text-white ${c.dice.color}`}>
                               {c.dice.name}
                            </div>
                            {mine && <div className="absolute top-1 right-1 bg-indigo-500 text-white p-0.5 rounded-full"><ArrowDown size={12}/></div>}
                         </button>
                       )
                    })}
                 </div>
                 
                 <div className="flex flex-wrap gap-2">
                   {currentRoom.players.map(p => {
                      const char = ROSTER[p.characterId];
                      return (
                      <div key={p.uid} className="flex items-center gap-2 bg-white px-3 py-1 rounded-full border shadow-sm">
                         <PlayerAvatar charId={p.characterId} size="sm" border={false}/>
                         <div className="flex flex-col">
                            <span className="font-bold text-sm leading-none">{p.name}</span>
                            <span className={`text-[10px] font-bold ${char.dice.text}`}>{char.dice.name}</span>
                         </div>
                      </div>
                   )})}
                 </div>
              </div>
            )}

            {view === 'game' && currentRoom && (
               <div className="w-full max-w-5xl flex flex-col gap-4">
                  
                  {/* GAME HEADER */}
                  <div className="flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-slate-200 sticky top-0 z-30">
                     <div className="flex items-center gap-3">
                        <div className="text-center">
                           <div className="text-[10px] text-slate-400 font-bold uppercase">TURNO DI</div>
                           <div className="font-black text-indigo-900 leading-none">{currentRoom.players[currentRoom.currentTurn].name}</div>
                        </div>
                        <PlayerAvatar charId={currentRoom.players[currentRoom.currentTurn].characterId}/>
                     </div>
                     
                     <div className="flex flex-col items-end">
                        {currentRoom.gameMode === 'elimination' && (
                           <div className="flex items-center gap-2 text-orange-600 font-black">
                              <Flame size={18}/> ROUND {currentRoom.round}
                           </div>
                        )}
                        <div className="text-xs text-slate-400 font-bold">{currentRoom.gameMode === 'classic' ? 'RAGGIUNGI IL 60!' : 'NON ARRIVARE ULTIMO!'}</div>
                     </div>
                  </div>

                  {/* BOARD */}
                  <div className="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-1.5 p-2 bg-slate-200/50 rounded-xl">
                     {Array.from({ length: (currentRoom.gameMode === 'elimination' ? ELIM_MAP.max : CLASSIC_MAP.max) + 1 }).map((_, i) => {
                        const config = currentRoom.gameMode === 'elimination' ? ELIM_MAP : CLASSIC_MAP;
                        const playersHere = currentRoom.players.filter(p => p.position === i && !p.isDead);
                        const currentPlayer = currentRoom.players[currentRoom.currentTurn];
                        const isPendingTarget = currentPlayer.uid === user.uid && currentPlayer.pendingTarget === i;
                        
                        return <BoardCell 
                                  key={i} 
                                  num={i} 
                                  players={playersHere} 
                                  special={config.specials[i]} 
                                  isElimination={currentRoom.gameMode === 'elimination'}
                                  isPendingTarget={isPendingTarget}
                                  onCellClick={() => executeMove(user.uid, i)}
                                  onInfoClick={(spec) => setSelectedCellInfo(spec)}
                               />
                     })}
                  </div>

                  {/* CONTROLS */}
                  <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 w-full max-w-sm px-4">
                     {currentRoom.status === 'finished' ? (
                        <div className="bg-indigo-900 text-white p-6 rounded-2xl shadow-2xl text-center border-4 border-yellow-400 animate-bounce">
                           <Trophy size={48} className="mx-auto text-yellow-400 mb-2"/>
                           <h2 className="text-3xl font-black">VITTORIA!</h2>
                           <p className="text-xl opacity-90">{currentRoom.players.find(p=>p.uid===currentRoom.winner)?.name} è il campione!</p>
                           <button onClick={() => { setView('menu'); setRoomCode(''); }} className="mt-4 bg-white text-indigo-900 px-6 py-2 rounded-full font-bold">Menu</button>
                        </div>
                     ) : (
                        <div className="space-y-2">
                           {/* SPECIAL DICE TOGGLE */}
                           {currentRoom.players[currentRoom.currentTurn].uid === user.uid && currentRoom.players[currentRoom.currentTurn].pendingTarget === null && (
                              <div className="bg-white p-2 rounded-xl shadow-lg border border-slate-200 flex justify-between items-center animate-in slide-in-from-bottom-5 fade-in duration-300">
                                 <div className="flex flex-col text-xs leading-tight">
                                     <span className="font-bold text-slate-500 uppercase">Dado Speciale</span>
                                     <span className={`font-black ${ROSTER[currentRoom.players[currentRoom.currentTurn].characterId].dice.text}`}>
                                        {ROSTER[currentRoom.players[currentRoom.currentTurn].characterId].dice.name}
                                     </span>
                                     <span className="text-[9px] text-slate-400">
                                        [{ROSTER[currentRoom.players[currentRoom.currentTurn].characterId].dice.vals.join(", ")}]
                                     </span>
                                 </div>
                                 <button 
                                   onClick={() => setUseSpecialDie(!useSpecialDie)} 
                                   className={`px-3 py-1.5 rounded-lg font-bold text-xs transition-all ${useSpecialDie ? `${ROSTER[currentRoom.players[currentRoom.currentTurn].characterId].dice.color} text-white shadow-md` : 'bg-slate-200 text-slate-500'}`}
                                 >
                                    {useSpecialDie ? 'ON' : 'OFF'}
                                 </button>
                              </div>
                           )}

                           <button 
                              onClick={handleRoll} 
                              disabled={
                                 isRolling || 
                                 isMoving ||
                                 (currentRoom.players[currentRoom.currentTurn].uid !== user.uid) || 
                                 currentRoom.players.find(p=>p.uid===user.uid)?.isDead ||
                                 currentRoom.players[currentRoom.currentTurn].pendingTarget !== null 
                              }
                              className={`w-full py-4 rounded-2xl font-black text-2xl shadow-xl transition-all flex items-center justify-center gap-3 border-b-8 active:border-b-0 active:translate-y-2 relative overflow-hidden
                                 ${isRolling || isMoving ? 'bg-slate-300 text-slate-500 border-slate-400' : 
                                 (currentRoom.players[currentRoom.currentTurn].uid === user.uid 
                                    ? (currentRoom.players[currentRoom.currentTurn].pendingTarget !== null 
                                       ? 'bg-yellow-500 text-white border-yellow-700 hover:bg-yellow-400' 
                                       : (useSpecialDie 
                                           ? `${ROSTER[currentRoom.players[currentRoom.currentTurn].characterId].dice.color} text-white border-black/20 hover:opacity-90`
                                           : 'bg-orange-500 text-white border-orange-700 hover:bg-orange-400')
                                       )
                                    : 'bg-slate-100 text-slate-400 border-slate-300 cursor-not-allowed')}`}
                           >
                              {isRolling ? <Dice5 className="animate-spin" size={32}/> : (useSpecialDie ? <Dices size={32}/> : <Dice5 size={32}/>)}
                              <span className="z-10 relative">
                                 {isRolling ? "..." : (lastRoll ? (currentRoom.players[currentRoom.currentTurn].pendingTarget !== null ? "CLICCA LA CASELLA!" : `TIRO: ${lastRoll}`) : "TIRA IL DADO")}
                              </span>
                           </button>
                        </div>
                     )}
                  </div>
                  
                  <div className="h-32"></div> {/* Spacer for fixed bottom */}
               </div>
            )}
            
          </div>

          {/* SIDEBAR LEADERBOARD REDESIGNED */}
          {view === 'game' && currentRoom && (
            <div className="hidden lg:flex flex-col w-80 bg-gradient-to-b from-indigo-900 via-purple-900 to-slate-900 text-white shadow-2xl z-20 border-l border-white/10">
               {/* Header */}
               <div className="p-5 border-b border-white/10 bg-black/20 backdrop-blur-md">
                  <div className="flex items-center gap-2 mb-1">
                     <Trophy className="text-yellow-400" size={20}/>
                     <h3 className="font-black text-lg tracking-wider">CLASSIFICA</h3>
                  </div>
                  <p className="text-xs text-white/50 font-medium uppercase tracking-widest">
                     {currentRoom.gameMode === 'classic' ? 'Gara di velocità' : 'Sopravvivenza'}
                  </p>
               </div>

               {/* List */}
               <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  {[...currentRoom.players]
                     .sort((a,b) => {
                        if (a.isDead && !b.isDead) return 1;
                        if (!a.isDead && b.isDead) return -1;
                        if (a.finished && !b.finished) return -1;
                        if (!a.finished && b.finished) return 1;
                        if (a.finished && b.finished) return a.rank - b.rank; 
                        return b.position - a.position; 
                     })
                     .map((p, i) => {
                        const isMe = p.uid === user.uid;
                        const rank = p.finished ? p.rank : (i+1);
                        let rankIcon = <span className="text-slate-400 font-mono font-bold">#{rank}</span>;
                        if (!p.isDead && rank === 1) rankIcon = <Crown size={20} className="text-yellow-400 fill-yellow-400 animate-pulse"/>;
                        if (!p.isDead && rank === 2) rankIcon = <Medal size={20} className="text-gray-300 fill-gray-300"/>;
                        if (!p.isDead && rank === 3) rankIcon = <Medal size={20} className="text-amber-600 fill-amber-600"/>;
                        if (p.isDead) rankIcon = <Skull size={20} className="text-red-500"/>;

                        return (
                        <div key={p.uid} 
                             className={`relative group p-3 rounded-xl transition-all duration-300 border backdrop-blur-sm
                                ${isMe ? 'bg-white/10 border-indigo-400 shadow-[0_0_15px_rgba(99,102,241,0.3)]' : 'bg-black/20 border-white/5 hover:bg-white/5'}
                                ${p.isDead ? 'opacity-50 grayscale' : ''}
                             `}
                        >
                           <div className="flex items-center gap-3">
                              <div className="w-8 flex justify-center">{rankIcon}</div>
                              <PlayerAvatar charId={p.characterId} size="sm" border={isMe}/>
                              <div className="flex-1 min-w-0">
                                 <div className={`font-bold text-sm truncate ${isMe ? 'text-white' : 'text-slate-200'}`}>{p.name}</div>
                                 <div className="flex items-center justify-between text-[10px] font-medium text-slate-400 mt-0.5">
                                    <span>
                                       {p.isDead ? 'ELIMINATO' : p.finished ? 'ARRIVATO!' : `CASELLA ${p.position}`}
                                    </span>
                                    {p.skipTurns > 0 && <span className="text-red-400 flex items-center gap-1"><RefreshCcw size={8}/> STOP {p.skipTurns}</span>}
                                 </div>
                              </div>
                           </div>
                           
                           {/* Dice Info Mini Badge */}
                           <div className={`absolute -bottom-2 right-2 px-2 py-0.5 rounded text-[9px] font-bold shadow-sm ${ROSTER[p.characterId].dice.color} text-white opacity-0 group-hover:opacity-100 transition-opacity`}>
                              {ROSTER[p.characterId].dice.name}
                           </div>
                        </div>
                     )})}
               </div>
               
               {/* Footer stats */}
               <div className="p-3 bg-black/40 text-[10px] text-center text-white/30 border-t border-white/5">
                  ID STANZA: <span className="font-mono text-white/50">{currentRoom.code}</span>
               </div>
            </div>
          )}

       </div>
    </div>
  );
}